name: Build the Client

on:
  push:
    tags:
      - '*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
        
    - name: Build it
      run: mvn -B package --file pom.xml

    - name: Prepare distribution
      run: |
        mkdir -p dist
        cp target/mud-client-1.0.0-shaded.jar dist/dwclient.jar
        cp run-windows.bat dist/
        cp run-mac.command dist/
        cp run-linux.sh dist/
        cp config-example.json dist/config.json
        cp delivery-routes.json dist/delivery-routes.json
        cp room-notes.json dist/room-notes.json
        cp database.db dist/database.db
        cp LICENSE dist/LICENSE
        RELEASE_NAME="dwclient"
        ZIP_NAME="dwclient-${{ github.ref_name }}.zip"
        cd dist && zip -r "../$ZIP_NAME" .
        echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_ENV
        echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: dwclient-zip
        path: ${{ env.ZIP_NAME }}

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: ${{ env.ZIP_NAME }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
